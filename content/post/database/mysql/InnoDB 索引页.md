---
title: "InnoDB 索引页"
description: 
date: 2020-10-27T19:29:31+08:00
lastmod: 2020-10-27T19:29:31+08:00
image: "https://blog-1259169620.cos.ap-guangzhou.myqcloud.com/img/%E6%88%AA%E5%B1%8F2022-07-10%2010.15.54.png"
math: 
license: MIT
hidden: false
comments: true
draft: false
tags: ["mysql", "innodb"]
categories: ["mysql"]
---

# InnoDB 索引页

## 一、概述

**索引页(`index page`)** 是 InnoDB 众多页类型中的一种，因为 InnoDB 的特点是 **索引组织表（`Index Organized Table`）** ，所以可以将索引页看成“数据页”。

InnoDB 的索引页组成如下图：

![InnoDB 数据页结构](https://blog-1259169620.cos.ap-guangzhou.myqcloud.com/img/%E6%88%AA%E5%B1%8F2022-07-10%2010.15.54.png)
可以通过这个表对索引页的各个部分有个基本的了解。

|        名称        |           中文名           | 占用空间大小 |        简单描述        |
|:------------------:|:--------------------------:|:------------:|:----------------------:|
|    File Header     |          文件头部          |    38字节    |    页的一些通用信息    |
|    Page Header     |          页面头部          |    56字节    |  索引页的一些专有信息  |
| Infimum & Supremum | 页面中的最小记录和最大记录 |    26字节    |     两个虚拟的记录     |
|    User Records    |          用户记录          |    不确定    |   用户存储的记录内容   |
|     Free Space     |          空闲空间          |    不确定    |   页中尚未使用的空间   |
|   Page Directory   |           页目录           |    不确定    | 页中某些记录的相对位置 |
|    File Trailer    |          文件尾部          |    8字节     |     校验页是否完整     |

## 二、用户记录的存储

用户存储的记录会按照指定的行格式插入到 **User Records** 部分，但是在开始生成页时，并没有 **User Records** 部分。每当插入一条记录时，都会从 **Free Space** 部分申请一个记录大小的空间并划分到 **User Records** 部分。

我们这里以 Compact 行格式为例来展开一下。

### Infimum & Supremum

InnoDB存储引擎会自动向数据页插入两条记录：**Infimum（最小记录）**、**Supremum（最大记录）** 。这两条记录也被称为伪记录/虚拟记录。

这两条记录的结构十分简单，都是由5个字节的记录头信息和8字节大小的一个固定单词组成。

![Infimum & Supremum](https://blog-1259169620.cos.ap-guangzhou.myqcloud.com/img/%E6%88%AA%E5%B1%8F2022-07-10%2016.49.37.png)

### 用户记录和[记录头信息](InnoDB%20记录存储格式.md#记录头信息)

#### next_record 字段

`next_record` 表示的是下一条记录的相对位置(地址偏移量)。**但需要注意的是，其并不是指向下一条记录的起始部分，而是指向下一条记录的数据内容的起始部分。**

这个属性值有正负之分，例如第一条记录的 `next_record` 值为 60 （十进制表示）时，则表示从这条记录的真实数据的地址处向后找 60 字节即是下一条记录的真实数据；当第三条记录的 `next_record` 值为 -112 时，则表示从这条记录的真实数据的地址处向前找 112 字节便是上一条记录的真实数据的起始处。

这其实也解释了为什么记录的额外信息部分(变长字段的长度列表、NULL值标志位)是按照列的顺序逆序排列的。因为此时数据内容部分中位置靠前的字段与其所对应的长度信息的相对距离更近。根据 **局部性原理** 可知，此举将可能会提高CPU高速缓存的命中率。

这里我们可以看到， 用户记录的各个行通过这个字段组成了一个 **单向链表** 。**链表的每个节点的后继节点都是下一个比它大的记录，这里的 “大小” 比的是主键的大小，而不是记录插入的前后顺序。当其中记录发生变化(新增、删除、修改)时，该链表也会适时调整，以满足链表按记录按照主键值从小到大的排序规则。**

特别的，针对这个记录链表而言无论其怎么变化，其表头、表尾永远是固定不变的，分别是Infimum 最小记录和 Supremum 最大记录，这也是此两条伪记录的命名来源。**可以看出这两条记录相当于是记录链表的哨兵节点。**

#### heap_no 字段

该字段表示的是记录在本页中的位置。**由于 Infimum最小记录、Supremum最大记录在用户插入的记录的前面，故分别为0、1**。故对于用户记录而言，该值从2开始。假设插入了三条记录，记录主键值分别为1，2， 3，那么记录1、记录2、记录3中该字段的值分别为2、3、4。

#### deleted_flag 字段

该字段为记录删除的标志位。当我们删除某记录时，不是直接从硬盘中删除，而是分为两个阶段：

1. **delete mask 阶段** ： 将该字段的值置为1。
2. **purge 阶段** ：将该记录加入垃圾链表。

对于垃圾链表中记录所占用的空间即为 **可重用空间** 。这样下次当有新的记录添加进来时，即可通过覆盖的方式来复用这部分存储空间。当然，所谓的垃圾链表也是通过被删除记录的`next_record` 字段作为指针来链接形成的。

## 三、 Page Directory 页目录

用户记录中的各个记录组成了类似单向链表的结构，其中，最小记录、最大记录分别为表头、表尾。我们知道单向链表的查找效率只有 `O(N)` 级别，如果每次都从表头去查询是很低效的。为此，引入了 **Page Directory** 。

### 页目录简介

首先我们将所有正常的记录（包括 Infimum 和 Supremum 记录，但不包括已经移除到垃圾链表的记录）划分为若干个分组。

每个分组的最后一条记录（即组内最大的记录）的 `n_owned` 字段表示该组内共有几条记录。

将每个组中最后一条记录在页面中的地址偏移量（即该记录的真实数据与页面中第0个字节之间的距离）按顺序存储到靠近页尾部的地方，也就是存到页目录中。页目录中的这些地址偏移量称为**槽（Slot）** ，各 Slot 根据其所指向的记录按从大到小的顺序在页目录中排列，其中每个槽占用2字节。

![InnoDB Page Directory](https://blog-1259169620.cos.ap-guangzhou.myqcloud.com/img/Page%20Directory.png)

这样我们在该页下如果需要通过主键来查找某条记录时，过程可以分为两步：

1. 通过 **二分法** 确定该记录所在分组对应的槽，然后找到该槽所在分组中主键值最小的记录（前一个槽最大记录主键值加1）。
2. 通过记录的 `next_record` 属性遍历该槽所在的组中的各个记录。

### 如何分组

InnoDB 对于每个分组中的记录数有规定：

1. Infimum 记录所在的分组只能有1条记录，即只有它自己；
2. Supremum 记录所在的分组的记录数量只能在1~8条记录之间；
3. 其他分组的记录数量只能在是4~8条记录之间。

具体地关于如何分组，基本步骤如下：

1. 在初始情况下，一个数据页中只有 Infimum 和 Supremum 这两条记录，它们分别属于两个分组。页目录中也只有两个槽，分别代表 Infimum 记录和 Supremum 记录在页面中的地址偏移量。
2. 之后每插入一条记录，都会从 Slot 0 开始遍历，直至找到第一个指向的记录比该新纪录大的槽。随后将槽所指向记录的 `n_owned` 记录值加1。
3. 为了避免某个分组内记录数量过多，当分组内的 **记录达到8** 时，此时如果再向此组内插入一条新记录，会导致此分组拆分为两个组，其中一个组4条另一个组5条记录。这个拆分过程会在页目录中新增一个槽，记录这个新增分组中最大记录的偏移量。

## 四、Page Header

**Page Header (页面头)** 描述的就是数据页类型的状态信息，下表是对 Page Header 的结构描述。

| 状态名称          | 占用空间大小 |                                                      描述                                                      |
| ----------------- |:------------:|:--------------------------------------------------------------------------------------------------------------:|
| PAGE_N_DIR_SLOTS  |    2字节     |                                                页目录中的槽数量                                                |
| PAGE_HEAP_TOP     |    2字节     |                                          Free Space剩余空间的起始地址                                          |
| PAGE_N_HEAP       |    2字节     | 第1位表示本记录是否为紧凑型的记录，剩余15位表示本页的堆中记录的数量（包括 Infimum 、Supremum和“已删除”的记录） |     |     |     |
| PAGE_FREE         |    2字节     |                     已被删除的记录的链表(即所谓的垃圾链表)的头节点对应记录在页面中的偏移量                     |     |     |     |
| PAGE_GARBAGE      |    2字节     |                                             已删除记录占用的字节数                                             |     |     |     |
| PAGE_LAST_INSERT  |    2字节     |                                               最后插入记录的位置                                               |     |     |     |
| PAGE_DIRECTION    |    2字节     |                                                 记录插入的方向                                                 |     |     |     |
| PAGE_N_DIRECTION  |    2字节     |                                           一个方向连续插入的记录数量                                           |     |     |     |
| PAGE_N_RECS       |    2字节     |                                              该页中用户记录的数量                                              |     |     |     |
| PAGE_MAX_TRX_ID   |    8字节     |                               修改当前页的最大事务id，该值仅在二级索引页面中定义                               |     |     |     |
| PAGE_LEVEL        |    2字节     |                                           当前页在 B+ 树中所属的层级                                           |     |     |     |
| PAGE_INDEX_ID     |    8字节     |                                         索引ID，表示当前页属于哪个索引                                         |     |     |     |
| PAGE_BTR_SEG_LEAF |    10字节    |                               B+ 树叶子节点段的头部信息，仅在 B+ 树的根页面定义                                |     |     |     |
| PAGE_BTR_SEG_TOP  |    10字节    |                             B+ 树非叶子节点段的头部信息，仅在 B+ 树的根页面中定义                              |     |     |     |

## 参考资料

* 小孩子 4919. (2020). _MySQL 是怎样运行的_. 人民邮电出版社.
