---
title: "MySQL的基础架构"
date: 2020-06-01T21:56:20+08:00
lastmod: 2020-07-23T22:14:18+08:00
description: ""
draft: false
tags: ["mysql"]
categories: ["mysql"]
---

# MySQL的基础架构

## 逻辑架构

MySQL可以大体分为**Server层**和**存储引擎层**两部分, 见图1

![图1 Mysql逻辑架构图](https://blog-1259169620.cos.ap-guangzhou.myqcloud.com/img/20211018154957.png)

<div style="text-align: center;">图1 Mysql逻辑架构图</div>


* **Server 层**包括连接器、查询缓存、分析器、优化器、执行器等，涵盖 MySQL 的大多数核心服务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。
* **存储引擎层**负责数据的存储和提取。其架构模式是**插件式**的，支持 InnoDB、MyISAM、Memory 等多个存储引擎。现在最常用的存储引擎是 **InnoDB**，它从 MySQL 5.5.5 版本开始成为了默认存储引擎



### 连接器(`Connector`)

连接器负责和客户端建立连接、获取权限、维持和管理连接。

```mysql
# Mysql连接命令
mysql -h$ip -P$port -u$user -p
```

MySQL 客户端和服务端完成TCP握手后，连接器需要认证身份

- 如果用户名或密码不对，就会收到一个 **Access denied for user** 的错误，然后客户端程序结束执行。

- 如果用户名密码认证通过，连接器会到权限表里面查出拥有的权限，之后这个连接里面的权限判断逻辑，都将依赖于此时读到的权限，这就意味着，一个用户成功建立连接后，即使这个用户的权限做了修改，也不会影响已经存在连接的权限。修改完成后，只有再新建的连接才会使用新的权限设置。

>  长连接是指连接成功后，如果客户端持续有请求，则一直使用同一个连接。短
连接则是指每次执行完很少的几次查询就断开连接，下次查询再重新建立一个。

#### 连接方式

1. TCP/IP
2. 命名管道和共享内存
3. UNIX 域套接字




### 查询缓存(`Query Cache`)

在连接建立完成后，MySQL 拿到一个查询请求后，会先到查询缓存看看，之前是不是执行过这条语句。之前执行过的语句及其结果可能会以 key-value 对的形式，被直接缓存在内存中。key 是查询的语句，value 是查询的结果。如果你的查询能够直接在这个缓存中找到 key，那么这个 value 就会被直接返回给客户端。

> 注：MySQL 8.0 版本的查询缓存功能被移除了



### 分析器(`Parser`)

分析器的主要功能是对SQL语句做解析

* 分析器会先做**词法分析**，再做**语法分析**，语法分析器会根据语法规则，判断 SQL 语句是否满足 MySQL 语法



### 优化器(`Query Optimizer`)

优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序。优化器并不关心表使用的是什么存储引擎，但存储引擎对于优化查询是有影响的。优化器会请求存储引擎提供容量或某个具体操作的开销信息，以及表数据的统计信息等。例如，某些存储引擎的某种索引，可能对一些特定的查询有优化。



### 执行器(`Query execution engine`)

开始执行的时候，要先判断一下对于表有没有执行操作的权限，如果没有，就会返回没有权限的错误。如果有权限，就打开表继续执行。打开表的时候，执行器就会根据表的引擎定义，去使用这个引擎提供的接口。



对于一个特定的例子

```mysql
select * from user where ID=10;
```

假定ID字段没有索引，那么执行器的执行流程是这样的：

1. 调用 InnoDB 引擎接口取这个表的第一行，判断 ID 值是不是 10，如果不是则跳过，如果是则将这行存在结果集中；
2. 调用引擎接口取“下一行”，重复相同的判断逻辑，直到取到这个表的最后一行。
3. 执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端。

