---
title: "HTTP/2"
date: 2020-07-10T15:51:57+08:00
lastmod: 2020-07-12T17:11:57+08:00
description: ""
draft: false
tags: ["计算机网络", "HTTP"]
categories: ["计算机网络"]
---

# HTTP/2

## 一、概述

> **HTTP/2** 的主要目标是通过支持完整的请求与响应复用来减少延迟，通过有效压缩 HTTP 标头字段将协议开销降至最低，同时增加对请求优先级和服务器推送的支持。 为达成这些目标，HTTP/2 还给我们带来了大量其他协议层面的辅助实现，例如新的流控制、错误处理和升级机制。

为了实现 HTTP 工作组设定的性能目标，**HTTP/2** 引入了一个新的二进制分帧层，**该层无法与之前的 HTTP/1.x 服务器和客户端向后兼容**，因此协议的主版本提升到 **HTTP/2**。



## 二、HTTP/1.x的缺陷

**HTTP/1.x** 实现简单是以牺牲性能为代价的：

* 客户端需要使用多个连接才能实现并发和缩短延迟
* 不会压缩请求和响应首部，从而导致不必要的网络流量
* 不支持有效的资源优先级，致使底层 TCP 连接的利用率低下



## 三、二进制分帧层

**HTTP/2** 所有性能增强的核心在于新的**二进制分帧层（`Binary framing layer`）**，它定义了如何封装 HTTP 消息并在客户端与服务器之间传输。

![二进制分帧层](https://gitee.com/huanghuang927/picture-host/raw/master/20211123115225.svg)

这里所谓的“层”，指的是位于套接字接口与应用可见的高级 HTTP API 之间一个经过优化的新编码机制: HTTP 的语义（包括各种动词、方法、标头）都不受影响，不同的是传输期间对它们的编码方式变了。 HTTP/1.x 协议以换行符作为纯文本的分隔符，而 HTTP/2 将所有传输的信息分割为更小的消息和帧，并采用二进制格式对它们编码。

这样一来，客户端和服务器为了相互理解，都必须使用新的二进制编码机制: HTTP/1.x 客户端无法理解只支持 HTTP/2 的服务器，反之亦然。 现有的应用不必担心这些变化，因为客户端和服务器会替我们完成必要的分帧工作。

### 数据流、消息和帧

> **数据流（`Stream`）**：已建立的连接内的双向字节流，可以承载一条或多条消息。

> **消息（`Message`)**：与逻辑请求或响应消息对应的完整的一系列帧

> **帧（`Frame`）**：HTTP/2 通信的最小单位，每个帧都包含帧头，至少也会标识出当前帧所属的数据流

所有通信都在一个 TCP 连接上完成，此连接可以承载任意数量的双向数据流：

- 每个数据流都有一个唯一的标识符和可选的优先级信息，用于承载双向消息。
- 每条消息都是一条逻辑 HTTP 消息（例如请求或响应），包含一个或多个帧。
- 帧是最小的通信单位，承载着特定类型的数据，例如 HTTP 标头、消息负载等等。 来自不同数据流的帧可以交错发送，然后再根据每个帧头的数据流标识符重新组装。



![](https://gitee.com/huanghuang927/picture-host/raw/master/20211123143327.svg)

**HTTP/2** 将 HTTP 协议通信分解为二进制编码帧的交换，这些帧对应着特定数据流中的消息。所有这些都在一个 TCP 连接内复用。



## 四、请求与响应复用

在 **HTTP/1.x** 中，如果客户端要想发起多个并行请求以提升性能，则必须使用多个 TCP 连接。 这是 **HTTP/1.x** 交付模型的直接结果，该模型可以保证每个连接每次只交付一个响应（响应排队）。 更糟糕的是，这种模型也会导致**队首阻塞**，从而造成底层 TCP 连接的效率低下。

**HTTP/2** 中新的二进制分帧层突破了这些限制，实现了**完整的请求和响应复用**: 客户端和服务器可以将 HTTP 消息分解为互不依赖的帧，然后交错发送，最后再在另一端把它们重新组装起来。

![](https://gitee.com/huanghuang927/picture-host/raw/master/20211123170352.svg)

**HTTP/2** 中的新二进制分帧层解决了 HTTP/1.x 中存在的队首阻塞问题，也消除了并行处理和发送请求及响应时对多个连接的依赖。 结果，应用速度更快、开发更简单、部署成本更低。

## 五、服务器推送

**HTTP/2** 新增的另一个强大的新功能是，服务器可以对一个客户端请求发送多个响应。 换句话说，除了对最初请求的响应外，服务器还可以向客户端推送额外资源，而无需客户端明确地请求。

![](https://gitee.com/huanghuang927/picture-host/raw/master/20211123170731.svg)

## 六、标头压缩

**HTTP/2** 使用 **HPACK** 压缩格式压缩请求和响应标头元数据。

![](https://gitee.com/huanghuang927/picture-host/raw/master/20211123170928.svg)

## 参考资料

- [HTTP/2简介](https://developers.google.com/web/fundamentals/performance/http2/?hl=zh-cn)

