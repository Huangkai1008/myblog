---
title: "IP"
description: 
date: 2020-10-17T21:07:31+08:00
lastmod: 2020-10-24T22:43:31+08:00
image: "https://blog-1259169620.cos.ap-guangzhou.myqcloud.com/img/IPv4_Packet.png"
math: 
license: MIT
hidden: false
comments: true
draft: false
tags: ["计算机网络", "网络层"]
categories: ["计算机网络"]
---
---
# IP

**网际协议（`Internet Protocol`）** 是[网络层](网络层.md)的重要协议。在今天，有两个版本的 IP 正在使用，一个是现阶段仍广泛部署的 `IPv4` [RFC 791]，另一个是 `IPv6` [RFC2460; RFC 4291]。

## 一、IPv4 数据报格式

`IPv4` 数据报中的关键字段有：

* **版本号(`version`)** ：长度为 4 bit ，规定了数据报的 IP 协议版本。
* **首部长度（`Header Length`）** ：长度为 4 bit ，因为一个 IPv4 数据报可能包含可变数量的选项，所以需要用此字段来确定数据报中载荷（例如在这个数据报中被封装的运输层报文段）实际开始的地方。当 IP 数据报不包含选项时，首部长度一般为 20 字节。
* **服务类型（`Type of service, TOS`）** ：用来区分不同类型的 IP 数据报，例如可以区分实时数据报和非实时数据报。
* **数据报长度（`Datagram length`）**：长度为16 bit ，标识 IP 数据报的总长度（首部加上数据），用字节来计量，所以 IP 数据报的理论最大长度为 2 ^ 16 - 1 = 65535 字节。
* **标识（`Identifier`）** 、**标志（`Flags`）** 、 **片位移（`Fragmentation offset`）** ：这三个首部字段与 [IPv4分片](IP.md#二、%20IPv4%20数据报分片)有关。
* **寿命(`Time-to-live, TTL`)** ：此字段用来防止数据报在网络中无限循环。当一台路由器处理数据报时，TTL 的值减1，当 TTL 为0时，该数据报必须丢弃。
* **协议（`Upper-layer protocol`）** ：该字段值标识了此数据报应该交给哪个特地的上层传输层协议。
* **首部检验和（`Header checksum`）** ：此字段用于帮助路由器检测收到的 IP 数据报中的比特错误。
* **源和目的 IP 地址（`Source and destination IP addresses`）** ：当源生成一个数据报时，在源 IP 地址字段插入它的 IP 地址，在目的 IP 地址字段插入其最终目的地的地址。
* **选项（`Options`）**
* **数据/有效载荷（`Data/Payload`）** ：IP 数据报的数据字段包含要交付给目的地的运输层报文段，也可以承载例如 ICMP 报文。

 ## 二、 IPv4 数据报分片

一个链路层帧可以承载的最大数据量叫做 **最大传送单元（`Maximum Transmission Unit, MTU`）** 。MTU 严格限制着 IP 数据报的长度，如果一个 IP 数据报的长度大于 MTU，则需要进行分**片（`fragment`）**。

## 三、 IPv4 地址

主机与链路之间的边界叫做 **接口（`interface`）** 。对于路由器来说，路由器必须拥有两条及以上的链路与它连接。路由器与它的任意一条链路之间的边界也叫做接口。因此，一台路由器有多个接口。

IP 要求每台主机和路由器接口拥有自己的 IP 地址，因此，从技术上来讲，**一个 IP 地址与一个接口相关联，而不是与包括该接口的主机或路由器相关联。**

### IPv4 地址的格式

每个  **IP 地址（`Internet Protocol address`）** 长度为 32 比特（等价为 4 字节），通常按照 **点分十进制记法（`dotted-decimal notation`）** 记录。

所谓点分十进制记法，即32 个二进制位分成了 4 个八位组（1 个八位组 = 8 个二进制位），每个八位组转换成了十进制并由句点（点）分隔。 每个八位组值的范围从 0 到 255（十进制）或从 00000000 到 11111111（二进制）。

```bash
      10.       1.      23.      19 (decimal)
00001010.00000001.00010111.00010011 (binary)
```

-----------------
### IPv4 地址编址方式

IP 地址的编址方式经历了三个历史阶段：

-   **分类**
-   **子网划分**
-   **无分类**

#### 分类
-------
IP地址由两部分组成，**网络号**和**主机号**，其中不同分类具有不同的网络号长度，并且是固定的

> **网络号**(`net-id`)：标志主机或路由器连接的网络，一个网络号在整个因特网内是唯一的

> **主机号**(`host-id`)：标志该主机（或路由器）。一个主机号在它前面的网络号所指明的网络范围内必须是唯一的

简而言之，**IP 地址 ::= {< 网络号 >, < 主机号 >}**

根据 IP 地址的范围，由此便划分出A、B、C三类及特殊地址D、E：

| 类别 | 起始位 |   开始    |     结束      | 点分十进制掩码 |
| :--: | :----: | :-------: | :-----------: | :------------: |
|  A   |   0    |  0.0.0.0  |   127.0.0.0   |   255.0.0.0    |
|  B   |   10   | 128.0.0.0 |  191.255.0.0  |  255.255.0.0   |
|  C   |  110   | 192.0.0.0 | 223.255.255.0 | 255.255.255.0  |

[^注]: 由于近年来已经广泛使用 **无类别域间路由（Classless Inter-Domain Routing、CIDR）** 进行路由选择，A类、B类和C类地址的区分已成为历史[RFC 1812]

#### 子网划分

1. 主机号有N位，那么这个地址中，就只能有`2 ** n − 2`个主机，因为其中全0作为网络地址，全1作为广播地址。
2. 将IP地址与子网掩码做`与运算`，如果得出的结果一样，则这两个IP地址是同一个子网当中。

-------
#### 子网掩码

> 子网掩码(subnet mask)又叫网络掩码、地址掩码、子网络遮罩，它是一种用来指明一个IP地址的哪些位标识的是主机所在的子网，以及哪些位标识的是主机的位掩码。

通常情况下，子网掩码的表示方法和地址本身的表示方法是一样的。在IPv4中，就是点分十进制四组表示法（四个取值从0到255的数字由点隔开，比如255.128.0.0）或表示为一个八位十六进制数（如FF.80.00.00，它等同于255.128.0.0），后者用得较少。

另一种更为简短的形式叫做[无类别域间路由](https://zh.wikipedia.org/wiki/无类别域间路由)（CIDR）表示法，它给出的是一个地址加上一个斜杠以及网络掩码的二进制表示法中“1”的位数（即网络号中和网络掩码相关的是哪些位）。例如，192.0.2.96/28表示的是一个前28位被用作网络号的IP地址（和255.255.255.240的意思一样）。

**子网掩码是由32位二进制数字组成的四组数字，左边是网络位，用二进制数字1表示，1的个数等于网络位数的长度，右边是主机位，用二进制数字0表示，0的个数等于主机位的长度。**

当给定一个IP地址后，我们**通过相应的子网掩码即可得出该地址所在网络的网络号位数，以此判断该网络能够容纳的机器的个数（即主机号位数）**。另外的一个作用就是可以通过运算判断两台机器是否处在同一子网。

**特点** ：

* 与IP地址一一对应
* 1和0永远是连续的，不会交叉出现
* 左边永远是1，右边永远是0

#### 广播地址(`Broadcast address`)

> 广播地址是专门用于同时向该网络中所有主机进行广播的一个地址。这就好像我们去收听一个广播频道，广播频道本身就是一个广播地址，播音员向这个地址去进行推送，那么只要能够收到这个频道的听众就都能够听到广播。那么这个广播的覆盖面到底有多广呢，这还是取决于我们的网络号。我们知道，一个完整的IP地址是由网络号和主机号两部分组成的，那么广播的覆盖范围就是其所在网络下的所有主机。

只要把主机号所在的二进制位全部变为1即可得到广播地址。

* 局域网地址：192.168.211.32/24（斜杠后的数字代表子网掩码的二进制位数，那么主机号的位数为32-24=8），所以广播地址为：192.168.211.255
