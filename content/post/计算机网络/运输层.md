---
title: "运输层"
description: 
date: 2020-08-18T09:21:31+08:00
lastmod: 2020-08-18T09:21:31+08:00
image: 
math: 
license: MIT
hidden: false
comments: true
draft: false
tags: ["计算机网络"]
categories: ["计算机网络"]
---
## 一、概述

运输层协议为运行在不同主机上的应用进程之间提供了 **逻辑通信（`logic communication`）** 功能。

通过逻辑通信，运行不同进程的主机好像直接相连一样。应用进程使用运输层提供的逻辑通信功能彼此发送报文，而无须考虑承载这些报文的物理基础设施的细节。

### 端口号

端口号是一个16比特的数，其大小在 0 ~ 65535 之间。

0 ~ 1023 范围的端口号称为 **周知端口号（`well-known port number`）** ，是受限制的，这些端口号一般保留给 HTTP 和 FTP 之类的周知应用层协议。

### 多路复用和多路分解

在源主机从不同套接字中收集数据块，并为每个数据块封装上首部信息从而生成报文段，然后将报文段传递到网络层，所有这些工作称为 **多路复用（`multiplexing`）** 。

将运输层报文段中的数据交付到正确的套接字的工作称为 **多路分解（`demultiplexing`）** 。

#### 多路复用的实现

运输层多路复用的要求和实现对应是：

1. 套接字有唯一标识符 -- **源端口号字段（`source port number field`）**

2. 每个报文段有特殊字段来指示该报文段所要交付的字段 -- **目的端口号字段（`destination port number field`）**

#### 多路分解的实现

在主机上的每个套接字能够分配一个端口号，当报文段到达主机时，运输层检查报文段中的目的端口号，并将其定向到相应的套接字。然后报文段中的数据通过套接字进入所连接的进程。

## 二、UDP

UDP 是一种不提供不必要服务的轻量级运输协议，它仅提供最小服务。

### UDP 的特点

* **UDP 是无连接的，在两个进程通信前没有握手过程。** 因此 UDP 不会引入建立连接的时延。

* **UDP 没有连接状态。** 对应上一点提到的，因为 UDP 是无连接的，所以 UDP 不需要维护连接状态。

* **UDP 提供不可靠数据服务。** 当进程将一个报文发送进 UDP 套接字时，UDP 协议并不保证该报文将到达接收进程。除此之外，UDP 也不能保证报文的到达顺序，意味着到达接收进程的报文可能是乱序到达的。

* **应用层控制可以做到更加精细。** UDP 协议不包括拥塞控制策略，意味着 UDP 的发送端可以用选定的任意速率发送数据。应用层有着更大的实现自由，例如一些实时应用可以使用 UDP ，并作为应用的一部分来实现所需的、超出 UDP 的额外功能。

* **分组首部开销小。** 对比 TCP 协议有着20字节的首部开销，UDP 仅有8字节的首部开销。

### UDP 数据报结构

**UDP 数据报（`UDP datagram`）** 包含 **报头（`datagram header`）** 和 **数据字段(`data section`)** 两部分。

![UDP Datagram](https://blog-1259169620.cos.ap-guangzhou.myqcloud.com/img/UDP%20Datagram.png)

#### UDP 协议头

UDP 协议头包含4个字段，分别是源端口、目的端口、长度和校验码，其中每一个字段都占16bit，即2个字节。

* **源端口** ：可选字段，它表示发送方进程的端口号，并且应假定为在需要时要回复的端口。
* **目的端口** ：必需字段，数据报接收方的端口号。
* **长度** ：协议头和数据报中数据的字节长度。最小长度为8字节，即标头的长度。
* **校验和**：用于协议头和数据的差错检测。在IPv4中可选，在IPv6中是必需的。

对于如下的一个使用 Wireshark 抓包的例子

![UDP header example](https://blog-1259169620.cos.ap-guangzhou.myqcloud.com/img/%E6%88%AA%E5%B1%8F2022-04-21%2008.27.44.png)

上述 UDP 首部中四个字段对应的值如下：

|   字段   |    数据     |
|:--------:|:-----------:|
|  源端口  | 0x1f5d=8029 |
| 目的端口 | 0x0747=1863 |
|   长度   |  0x0023=35  |
|  校验和  |   0x9019    |

#### UDP 校验和

UDP 校验和提供了差错检测功能，校验和用于确定当 UDP 报文段从源到目的地移动时，其中的比特是否发生了改变。

发送方的 UDP 对报文段中的所有16比特字的和进行反码运算，求和时遇到的任何溢出都会被回卷，得到的结果放在校验和字段。

* ****

## 参考资料

* Kurose, J. F., & Ross, K. W. (2018). *计算机网络-自顶而下方法* (7th ed.). 机械工业出版社.
* [Wikipedia : User Datagram Protocol](https://en.wikipedia.org/wiki/User_Datagram_Protocol)
